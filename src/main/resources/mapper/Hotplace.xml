<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.enjoytrip.dao.hotplace.HotplaceDao">

	<select id="searchHotplace"
		parameterType="HotplaceSearchCondition" resultType="Hotplace">
		select
			hotplace.hotplace_id,
			hotplace.user_id,
			hotplace.title,
			hotplace.content,
			hotplace.image,
			hotplace.created_at,
			hotplace.updated_at,
			hotplace.attraction_id,
			hotplace.read_count
		from 
			hotplace
		<where>
			<trim prefixOverrides="AND">
				<if test="hotplaceId!=null">
					AND hotplace.hotplace_id = #{hotplaceId}
				</if>
				<if test="userId!=null">
					AND hotplace.user_id = #{userId}
				</if>
				<if test="keywordTitle">
					AND hotplace.title like CONCAT('%',#{keywordTitle},'%')
				</if>
			</trim>
		</where>
		GROUP BY
        	hotplace.hotplace_id
		<choose>
			<when test="sortOrder==null">
				order by updated_at ASC
			</when>
			<when test="sortOrder.name()=='DICTIONARY_ASC'">
				order by title ASC
			</when>
			<when test="sortOrder.name()=='DICTIONARY_DESC'">
				order by title DESC
			</when>
			<when test="sortOrder.name()=='READCOUNT_ASC'">
				order by read_count ASC
			</when>
			<when test="sortOrder.name()=='READCOUNT_DESC'">
				order by read_count DESC
			</when>
			<when test="sortOrder.name()=='COMMENT_ASC'">
				ORDER BY COUNT(comments.hotplace_id) ASC
			</when>
			<when test="sortOrder.name()=='COMMENT_DESC'">
				ORDER BY COUNT(comments.hotplace_id) DESC
			</when>
			<when test="sortOrder.name()=='BOOKMARK_ASC'">
				ORDER BY COUNT(hotplace_bookmark_favor.hotplace_id) ASC
			</when>
			<when test="sortOrder.name()=='BOOKMARK_DESC'">
				ORDER BY COUNT(hotplace_bookmark_favor.hotplace_id) DESC
			</when>
			<when test="sortOrder.name()=='FAVOR_ASC'">
				ORDER BY COUNT(hotplace_bookmark_favor.hotplace_id) ASC
			</when>
			<when test="sortOrder.name()=='FAVOR_DESC'">
				ORDER BY COUNT(hotplace_bookmark_favor.hotplace_id) DESC
			</when>
		</choose>
	</select>

	<insert id="createHotplace" useGeneratedKeys="true" parameterType="Hotplace" keyProperty="hotplaceId">
		INSERT INTO
			hotplace (user_id, title, content, image, created_at, updated_at, attraction_id, read_count)
		VALUES (#{userId}, #{title}, #{content}, #{image}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, #{attractionId}, 0)
	</insert>
	
	<update id="updateHotplace" parameterType="Hotplace">
		UPDATE hotplace
		SET
			<trim suffixOverrides=",">
				<if test="title!=null">
					,title= #{title}
				</if>
				<if test="content!=null">
					,content= #{title}
				</if>
				<if test="title!=null">
					,title= #{title}
				</if>
				<if test="title!=null">
					,title= #{title}
				</if>
			</trim>
		WHERE hotplace_id = #{hotplaceId}
	</update>
	
	<delete id="deleteHotplace" parameterType="Hotplace">
		DELETE FROM hotplace
		WHERE hotplace_id = #{hotplaceId}
	</delete>
	
</mapper>